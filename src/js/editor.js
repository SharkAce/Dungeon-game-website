let spriteSheetURL,spriteSheet,spriteSize,levelSize={x:0,y:0},selected={id:17,fg:!1,rotation:0,multiSelectedIds:[],multiSelectedWidth:0,multiSelectedHeight:0,isMulti:!1,collisionMode:!1},bgLevelArray=[],fgLevelArray=[],collisionLevelArray=[],drawSpace={tileSize:null,spriteArray:[],multiSelectedPos:[]},selector={width:400,tileSize:25,spriteArray:[],multiSelectedPos:[]};class Tile{constructor(e,t){this.id=e,this.rotation=t,this.selected="id"}toString(){return this[this.selected]}}class Point{constructor(e,t){this.x=e,this.y=t}}const s=e=>{e.setup=function(){e.createCanvas(e.displayWidth,e.displayHeight),e.angleMode(e.DEGREES),drawSpace.tileSize=(e.displayWidth-selector.width)/levelSize.x,selector.spriteArray=loadSpriteArray(spriteSheet,selector.tileSize,255,255),drawSpace.spriteArray=loadSpriteArray(spriteSheet,drawSpace.tileSize,255,255)},e.draw=function(){e.background(120),e.fill(255),e.rect(0,0,selector.width,e.displayHeight),drawSelectTiles(e),drawSelectRect(e),drawSpace.editLevelSingle(e),drawGrid(e),drawEditedLevel(e,bgLevelArray),drawEditedLevel(e,fgLevelArray),drawCollisions(e),drawInfo(e)},e.preload=function(){spriteSheet=e.loadImage(spriteSheetURL)},e.mouseClicked=function(){e.mouseX<selector.width?selector.click(e):drawSpace.click(e),e.keyPressed=function(){"s"===e.key?exportFile():"r"===e.key?selected.rotation=3==selected.rotation?0:selected.rotation+1:"d"===e.key?(selected.id=-1,selected.isMulti=!1,selected.collisionMode=!1):"c"===e.key&&(selected.collisionMode=!0,selected.isMulti=!1)}},selector.click=function(e){let t=Math.floor(e.mouseX/selector.tileSize),l=Math.floor(e.mouseY/selector.tileSize);if(selected.fg=e.keyIsDown(e.SHIFT),selected.collisionMode=!1,e.keyIsDown(e.CONTROL)){if(selector.multiSelectedPos.push(new Point(t,l)),2==selector.multiSelectedPos.length){let i=selector.multiSelectedPos[0],r=selector.multiSelectedPos[1];selector.multiSelectedPos=[],selected.multiSelectedIds=[],selected.isMulti=!0,selected.multiSelectedWidth=r.x-i.x,selected.multiSelectedHeight=r.y-i.y;for(let d=i.x;d<=r.x;d++)for(let c=i.y;c<=r.y;c++)selected.multiSelectedIds.push(c*(spriteSheet.width/spriteSize)+d)}}else selected.id=l*(spriteSheet.width/spriteSize)+t,selector.multiSelectedPos=[],selected.multiSelectedIds=[],selected.isMulti=!1},drawSpace.click=function(e){let t=Math.floor((e.mouseX-selector.width)/drawSpace.tileSize),l=Math.floor(e.mouseY/drawSpace.tileSize);selected.isMulti?drawSpace.editLevelSelectedMulti(t,l):e.keyIsDown(e.CONTROL)&&(drawSpace.multiSelectedPos.push(new Point(t,l)),2==drawSpace.multiSelectedPos.length&&drawSpace.editLevelMulti(drawSpace.multiSelectedPos[0],drawSpace.multiSelectedPos[1]))}};function drawInfo(e){e.fill(0),e.text(`rotation: ${90*selected.rotation}`,5,500),e.text(`delete mode: ${-1==selected.id}`,5,515),e.text(`collision mode: ${selected.collisionMode}`,5,530),e.text("keys:",5,555),e.text("r: rotate",25,570),e.text("d: delete mode",25,585),e.text("c: collision mode",25,600),e.text("s: save",25,615),e.text("Shift: select foreground",25,630),e.text("Ctrl: select/draw area",25,645),e.fill(255)}function exportFile(){let e=`${levelSize.x},${levelSize.y}`;e+=encodeLine(bgLevelArray,"id"),e+=encodeLine(bgLevelArray,"rotation"),e+=encodeLine(fgLevelArray,"id"),e+=encodeLine(fgLevelArray,"rotation"),saveFile("level.ptlt",e+=encodeLine(collisionLevelArray,""))}function encodeLine(e,t){let l="";return l+="\n",""!=t&&e.forEach(e=>e.forEach(e=>e.selected=t)),e.forEach(e=>{l+=e.join(","),l+=","}),l=l.slice(0,-1)}function saveFile(e,t){let l=new Blob([t],{type:"text/csv"});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveBlob(l,e);else{let i=window.document.createElement("a");i.href=window.URL.createObjectURL(l),i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i)}}function startEditor(){spriteSheetURL="https://raw.githubusercontent.com/SharkAce/Dungeon-game/main/res/0x72_16x16DungeonTileset.v4.png",levelSize.x=40,levelSize.y=23,spriteSize=16,bgLevelArray=initLevelArray(-1),fgLevelArray=initLevelArray(-1),collisionLevelArray=initLevelArray(0),new p5(s)}function loadImageURL(e){let t=e.files[0];return URL.createObjectURL(t)}function loadSpriteArray(e,t,l,i){let r=[];for(let d=0;d<i;d+=spriteSize)for(let c=0;c<l;c+=spriteSize)r.push(e.get(c,d,spriteSize,spriteSize));return r.forEach(e=>e.resize(t,t)),r}function initLevelArray(e){let t=[];for(let l=0;l<levelSize.y;l++){yArray=[];for(let i=0;i<levelSize.x;i++)yArray.push(new Tile(e,0));t.push([...yArray])}return t}function drawGrid(e){for(let t=0;t<=levelSize.y;t++){let l=t*drawSpace.tileSize;e.line(selector.width,l,e.displayWidth,l)}for(let i=0;i<=levelSize.x;i++){let r=i*drawSpace.tileSize+selector.width;e.line(r,0,r,e.displayHeight)}e.rect(selector.width,levelSize.y*drawSpace.tileSize,e.displayWidth,e.displayHeight)}function drawSelectTiles(e){let t=0;for(let l=0;l<selector.spriteArray.length/(spriteSheet.width/spriteSize);l++)for(let i=0;i<spriteSheet.height/spriteSize;i++)e.image(selector.spriteArray[t],i*selector.tileSize,l*selector.tileSize),t++}function drawSelectRect(e){if(!selected.collisionMode){if(e.noFill(),e.stroke(selected.fg?"red":"blue"),e.strokeWeight(3),selected.isMulti){let t=Math.floor(selected.multiSelectedIds[0]/(spriteSheet.width/spriteSize))*selector.tileSize,l=selected.multiSelectedIds[0]%(spriteSheet.width/spriteSize)*selector.tileSize;e.rect(l,t,(selected.multiSelectedWidth+1)*selector.tileSize,(selected.multiSelectedHeight+1)*selector.tileSize)}else{let i=Math.floor(selected.id/(spriteSheet.width/spriteSize))*selector.tileSize,r=selected.id%(spriteSheet.width/spriteSize)*selector.tileSize;e.rect(r,i,selector.tileSize,selector.tileSize)}e.stroke(0),e.strokeWeight(1),e.fill(255)}}function drawEditedLevel(e,t){e.imageMode(e.CENTER);for(let l=0;l<t.length;l++)for(let i=0;i<t[0].length;i++)if(-1!=t[l][i].id){let r=i*drawSpace.tileSize+selector.width+drawSpace.tileSize/2,d=l*drawSpace.tileSize+drawSpace.tileSize/2,c=90*t[l][i].rotation;e.translate(r,d),e.rotate(c),e.image(drawSpace.spriteArray[t[l][i].id],0,0,drawSpace.tileSize,drawSpace.tileSize),e.rotate(-1*c),e.translate(-1*r,-1*d)}e.rotate(0),e.imageMode(e.CORNER)}function drawCollisions(e){for(let t=0;t<collisionLevelArray.length;t++)for(let l=0;l<collisionLevelArray[0].length;l++)1==collisionLevelArray[t][l]&&e.text("c",l*drawSpace.tileSize+selector.width+drawSpace.tileSize/2,t*drawSpace.tileSize+drawSpace.tileSize/2)}drawSpace.editLevelSelectedMulti=function(e,t){switch(selected.rotation){case 0:{let l=0;for(let i=e;i<=e+selected.multiSelectedWidth;i++)for(let r=t;r<=t+selected.multiSelectedHeight;r++)selected.id=selected.multiSelectedIds[l],drawSpace.editTile(i,r),l++;drawSpace.multiSelectedPos=[];break}case 1:{let d=0;for(let c=t;c<=t+selected.multiSelectedWidth;c++)for(let o=e+selected.multiSelectedHeight;o>=e;o--)selected.id=selected.multiSelectedIds[d],drawSpace.editTile(o,c),d++;drawSpace.multiSelectedPos=[];break}case 2:{let a=0;for(let S=e+selected.multiSelectedWidth;S>=e;S--)for(let n=t+selected.multiSelectedHeight;n>=t;n--)selected.id=selected.multiSelectedIds[a],drawSpace.editTile(S,n),a++;drawSpace.multiSelectedPos=[];break}case 3:{let u=0;for(let p=t+selected.multiSelectedWidth;p>=t;p--)for(let h=e;h<=e+selected.multiSelectedHeight;h++)selected.id=selected.multiSelectedIds[u],drawSpace.editTile(h,p),u++;drawSpace.multiSelectedPos=[]}}},drawSpace.editLevelSingle=function(e){if(!e.mouseIsPressed||e.mouseX<selector.width||e.keyIsDown(e.CONTROL)||selected.isMulti)return;let t=Math.floor((e.mouseX-selector.width)/drawSpace.tileSize),l=Math.floor(e.mouseY/drawSpace.tileSize);drawSpace.editTile(t,l)},drawSpace.editLevelMulti=function(e,t){if(!selected.isMulti){for(let l=e.x;l<=t.x;l++)for(let i=e.y;i<=t.y;i++)drawSpace.editTile(l,i);drawSpace.multiSelectedPos=[]}},drawSpace.editTile=function(e,t){e>=levelSize.x||t>=levelSize.y||(selected.collisionMode?collisionLevelArray[t][e]=1:-1==selected.id?(bgLevelArray[t][e].id=-1,bgLevelArray[t][e].rotation=0,fgLevelArray[t][e].id=-1,fgLevelArray[t][e].rotation=0,collisionLevelArray[t][e]=0):selected.fg?(fgLevelArray[t][e].id=selected.id,fgLevelArray[t][e].rotation=selected.rotation):(bgLevelArray[t][e].id=selected.id,bgLevelArray[t][e].rotation=selected.rotation))};
